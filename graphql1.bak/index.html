<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
































<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="GraphQL可以理解为是一种标准，而与标准相对的便是实现。就像 EcmaScript 与 JavaScript 的关系。 给你的API发送一个GraphQL查询，可以不多不少的获取你想要的。 GraphQL Servers服务端 express-graphql | apollo-server GraphQL Clientsappolo-client：一款对React、React Native、A">
<meta name="keywords" content="前端">
<meta property="og:type" content="article">
<meta property="og:title" content="GraphQL">
<meta property="og:url" content="http://yoursite.com/graphql1.bak/index.html">
<meta property="og:site_name" content="苏三 • 博客">
<meta property="og:description" content="GraphQL可以理解为是一种标准，而与标准相对的便是实现。就像 EcmaScript 与 JavaScript 的关系。 给你的API发送一个GraphQL查询，可以不多不少的获取你想要的。 GraphQL Servers服务端 express-graphql | apollo-server GraphQL Clientsappolo-client：一款对React、React Native、A">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-05-31T02:59:31.223Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GraphQL">
<meta name="twitter:description" content="GraphQL可以理解为是一种标准，而与标准相对的便是实现。就像 EcmaScript 与 JavaScript 的关系。 给你的API发送一个GraphQL查询，可以不多不少的获取你想要的。 GraphQL Servers服务端 express-graphql | apollo-server GraphQL Clientsappolo-client：一款对React、React Native、A">






  <link rel="canonical" href="http://yoursite.com/graphql1.bak/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>GraphQL | 苏三 • 博客</title>
  












  <noscript>
  <style>
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion .logo-line-before i { left: initial; }
    .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">苏三 • 博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/graphql1.bak/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苏三">
      <meta itemprop="description" content="一枚文科毕业，工作5+年的程序媛👨‍💻。">
      <meta itemprop="image" content="/images/common/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苏三 • 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">GraphQL

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-27 14:45:48" itemprop="dateCreated datePublished" datetime="2019-05-27T14:45:48+08:00">2019-05-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-31 10:59:31" itemprop="dateModified" datetime="2019-05-31T10:59:31+08:00">2019-05-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>GraphQL可以理解为是一种标准，而与标准相对的便是实现。就像 EcmaScript 与 JavaScript 的关系。</p>
<p>给你的API发送一个GraphQL查询，可以不多不少的获取你想要的。</p>
<p>GraphQL Servers<br>服务端 express-graphql | apollo-server</p>
<p>GraphQL Clients<br>appolo-client：一款对React、React Native、Angular 2或者Javascript都非常友好<br>当然Andorid(Java) iOS(Swift / Objective-C)都有相应的实现</p>
<p>awesome-graphql：一个维护GraphQL的出色社区</p>
<p>GraphQL is a query language for your API, and a server-side runtime for executing queries by using a type system you define for your data.<br>GraphQL是一种API查询语言，和服务端运行时，类型定义系统执行查询。</p>
<h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><h5 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h5><h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><p>嵌套对象，是否可以加参数，嵌套的参数怎么查询？例如：<br>query student(studentId: 1) {<br>  name<br>  class (classId: 3) {<br>    index<br>  }<br>}</p>
<h5 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h5><h5 id="片段"><a href="#片段" class="headerlink" title="片段"></a>片段</h5><p>GraphQL查询包含可复用单元，比如任务列表，包含进行中、已完结，类似于<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fragment taskListFragment on Character &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">query tasks &#123;</span><br><span class="line">  processingTaskList &#123;</span><br><span class="line">    ...taskListFragment</span><br><span class="line">  &#125;</span><br><span class="line">  finishTaskList &#123;</span><br><span class="line">    ...taskListFragment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>操作类型包括query(简单的查询可以省略)、mutation和subscription</p>
<h5 id="操作名称"><a href="#操作名称" class="headerlink" title="操作名称"></a>操作名称</h5><h5 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h5><h5 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h5><p>@include(if: Boolean) 仅在参数为 true 时，包含此字段。<br>@skip(if: Boolean) 如果参数为 true，跳过此字段。<br>例如，以下的例子，只有在withFriends为true时，才会返回friends字段<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query Hero($episode: Episode, <span class="attr">$withFriends</span>: <span class="built_in">Boolean</span>!) &#123;</span><br><span class="line">  hero(episode: $episode) &#123;</span><br><span class="line">    name</span><br><span class="line">    friends @include(<span class="keyword">if</span>: $withFriends) &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h4><h5 id="InputType"><a href="#InputType" class="headerlink" title="InputType"></a>InputType</h5><h5 id="内联片段-定义接口interface和联合类型String-Number"><a href="#内联片段-定义接口interface和联合类型String-Number" class="headerlink" title="内联片段(定义接口interface和联合类型String | Number)"></a>内联片段(定义接口interface和联合类型String | Number)</h5><p>例子：<br>返回值是根据角色返回不同字段，则可以根据内联片段来区分。</p>
<h5 id="typename"><a href="#typename" class="headerlink" title="__typename"></a>__typename</h5><h4 id="Schema和类型"><a href="#Schema和类型" class="headerlink" title="Schema和类型"></a>Schema和类型</h4><p>GraphQL 服务可以用任何语言编写，因为我们并不依赖于任何特定语言的句法句式（譬如 JavaScript）来与 GraphQL schema 沟通，我们定义了自己的简单语言，称之为 “GraphQL schema language” —— 它和 GraphQL 的查询语言很相似，让我们能够和 GraphQL schema 之间可以无语言差异地沟通。</p>
<p>两个特殊类型Query和Mutation，GraphQL Clients使用query或mutation操作查询或更改，针对这两个入口，GraphQL Servers同样有两种类型来定义GraphQL入口。</p>
<h5 id="标量类型"><a href="#标量类型" class="headerlink" title="标量类型"></a>标量类型</h5><p>Int：有符号 32 位整数。<br>Float：有符号双精度浮点值。<br>String：UTF‐8 字符序列。<br>Boolean：true 或者 false。<br>ID：ID 标量类型表示一个唯一标识符，通常用以重新获取对象或者作为缓存中的键。ID 类型使用和 String 一样的方式序列化；然而将其定义为 ID 意味着并不需要人类可读型。</p>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>自定义标量类型<br>枚举</p>
<h6 id="列表和非空"><a href="#列表和非空" class="headerlink" title="列表和非空"></a>列表和非空</h6><p>[String]!和[String]!<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// myField: [String!]</span></span><br><span class="line">myField: <span class="literal">null</span>   <span class="comment">// success</span></span><br><span class="line">myField: []     <span class="comment">// success</span></span><br><span class="line">myField: [<span class="string">'a'</span>, <span class="string">'b'</span>] <span class="comment">//  success</span></span><br><span class="line">myField: [<span class="string">'a'</span>, <span class="literal">null</span>, <span class="string">'b'</span>] <span class="comment">// failed</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// myField: [String]!</span></span><br><span class="line">myField: <span class="literal">null</span>   <span class="comment">// failed</span></span><br><span class="line">myField: []     <span class="comment">// true</span></span><br><span class="line">myField: [<span class="string">'a'</span>, <span class="string">'b'</span>] <span class="comment">//  true</span></span><br><span class="line">myField: [<span class="string">'a'</span>, <span class="literal">null</span>, <span class="string">'b'</span>] <span class="comment">// true</span></span><br></pre></td></tr></table></figure></p>
<h6 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h6><p>指定类型之间的共同字段，每一个实现该接口的类型，必须包含该接口中存在的字段，从而实现该接口。</p>
<h6 id="联合类型"><a href="#联合类型" class="headerlink" title="联合类型"></a>联合类型</h6><p>String | Number</p>
<h6 id="输入类型-InputTypes"><a href="#输入类型-InputTypes" class="headerlink" title="输入类型(InputTypes)"></a>输入类型(InputTypes)</h6><p>通过使用类型系统，你可以预判一个查询是否有效。这让服务器和客户端可以在无效查询创建时就有效地通知开发者，而不用依赖运行时检查。</p>
<h4 id="GraphQL执行过程"><a href="#GraphQL执行过程" class="headerlink" title="GraphQL执行过程"></a>GraphQL执行过程</h4><p>您可以将 GraphQL 查询中的每个字段视为返回子类型的父类型函数或方法。事实上，这正是 GraphQL 的工作原理。每个类型的每个字段都由一个 resolver 函数支持，该函数由 GraphQL 服务器开发人员提供。当一个字段被执行时，相应的 resolver 被调用以产生下一个值。</p>
<ol>
<li>类型系统校验</li>
<li>解析函数解析</li>
<li>键值对映射，返回json</li>
</ol>
<p>如果字段产生标量值，例如字符串或数字，则执行完成。如果一个字段产生一个对象，则该查询将继续执行该对象对应字段的解析器，直到生成标量值。GraphQL 查询始终以标量值结束。</p>
<h5 id="Resolver"><a href="#Resolver" class="headerlink" title="Resolver"></a>Resolver</h5><p>每一个 GraphQL 服务端应用的顶层，必有一个类型代表着所有进入 GraphQL API 可能的入口点，我们将它称之为 Root 类型或 Query 类型。</p>
<p>优点</p>
<p>API版本控制我觉得这个优点有点牵强，他的解释是可以在原接口添加字段，按理说，原来的RESTful直接添加也没毛病。<br>后来思考了一下，还是有区别的，RESTful增加字段，老版本接口也会新增这个字段，而GraphQL不会。</p>
<h4 id="deprecated有待研究"><a href="#deprecated有待研究" class="headerlink" title="@deprecated有待研究"></a>@deprecated有待研究</h4><p>introspection 内省？</p>
<p>缓存实现原理</p>
<p>subscription订阅</p>
<p>缺点<br>N+1问题<br>DataLoader: 可以将多个数据库请求合并成一个，也可以缓存数据库查询结果</p>
<p>项目中现有的实现方式是不是没有将GraphQL的特性发挥出来？</p>
<ol>
<li>项目中仍然使用一个功能写一个对应的API接口，与RESTful类似，而不是采用一个接口，让客户端选择查询。 <a href="https://draveness.me/graphql-microservice" target="_blank" rel="noopener">集中式vs分布式</a></li>
</ol>
<p>GraphQL中，我们会有这样一个约定，Query和与之对应的Resolver是同名的，这样在GraphQL才能把它们对应起来，举个例子，比如关于articles(): [Article!]!这个Query, 它的Resolver的名字必然叫做articles。</p>
<p>Resolver内部实现对于GraphQL完全是黑盒状态</p>
<p>GraphQL查询语言-GraphQL Clients<br>GraphQL类型语言-GraphQL Servers</p>
<p>Query<br>Mutation<br>Subscription</p>
<p><a href="https://blog.apollographql.com/graphql-explained-5844742f195e" target="_blank" rel="noopener">GraphQL是怎么将一个Query转换成Response的？</a></p>
<ol>
<li><p>GraphQL queries</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  query getAuthor(id: <span class="number">5</span>)&#123;</span><br><span class="line">   name</span><br><span class="line">   posts &#123;</span><br><span class="line">     title</span><br><span class="line">     author &#123;</span><br><span class="line">       name</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Schema and resolve functions<br>每个GraphQL服务器都有两个关键的部分来决定该如何工作，那就是Schema和resolve functions。<br>Schema：定义了GraphQL服务器的数据模型，即client可以从这个GraphQL服务器获取到哪些数据及数据结构是什么样的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">type Author &#123;</span><br><span class="line">  id: Int</span><br><span class="line">  name: <span class="built_in">String</span></span><br><span class="line">  posts: [Post]</span><br><span class="line">&#125;</span><br><span class="line">type Post &#123;</span><br><span class="line">  id: Int</span><br><span class="line">  title: <span class="built_in">String</span></span><br><span class="line">  text: <span class="built_in">String</span></span><br><span class="line">  author: Author</span><br><span class="line">&#125;</span><br><span class="line">type Query &#123;</span><br><span class="line">  getAuthor(id: Int): Author</span><br><span class="line">  getPostsByTitle(titleContains: <span class="built_in">String</span>): [Post]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正如上面的例子，包含三种类型，Query、Author、Post，其中Query标志着查询的入口，每个查询都需要从Query的字段开始，比如getAuthor、getPostsByTitle。通过Author可以查询某个作者拥有的文章列表，当然也可以通过某篇文章查询文章作者信息，这就是Schema的作用：(1) client端可以获取哪些字段 (2) 描述字段间的关系</p>
<p>Resolve Functions<br>解决参数是什么？根据参数怎么获取所需数据？GraphQL Resolve Functions可以包含任意代码,这意味着GraphQL服务器可以与任何类型的后端交互。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getAuthor(_, args)&#123;</span><br><span class="line">  <span class="keyword">return</span> sql.raw(<span class="string">'SELECT * FROM authors WHERE id = %s'</span>, args.id);</span><br><span class="line">&#125;</span><br><span class="line">posts(author)&#123;</span><br><span class="line">  <span class="keyword">return</span> request(<span class="string">`https://api.blog.io/by_author/<span class="subst">$&#123;author.id&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li>GraphQL execution(以GraphQL-JS为例，基本上所有的GraphQL服务端实现都遵循以下步骤)<br>响应步骤：<br>（1）解析：服务器首先解析查询语句，将其转换成抽象语法树，如果有任何语法错误，服务器则会停止运行，并将错误返回给client端<br>（2）验证：验证查询语句，参数及返回值字段是否存在在schema中(比如getAuthor是否是Query的一个字段，getAuthor是否接受一个名为id的参数字段，getAuthor是否有返回name、posts字段等)，GraphQL-JS在真正执行之前，会自动所有完成验证操作。<br>（3）执行：GraphQL从query的顶部开始执行。</li>
</ol>
<p>  GraphQL拥有自己的类型语言，用来定义Schema，称之为Schema Definition Language(SDL)。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type User &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  name: <span class="built_in">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  User类型只是简单的定义了应用中user模型的数据结构，如果想要获取id或name值，就需要将其挂载在Query下。<br>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">  user(id: ID!): User</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  定义入口是GraphQL能正确执行的前提条件，只有在Query类型下定义了正确的Schema，以下查询语句才能执行<br>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  user(id: <span class="number">3</span>) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 注：Query、Mutation、Subscription类型的定义是调用GraphQL API入口</p>
<p>GraphQL engine(比如GraphQL.js)<br>GraphQL.js是GraphQL的实现，并为其他库(比如graphql-tools、graphene-js)提供了基石。所有库的实现都是围绕GraphQLSchema对象的两个组成部分：模型声明Schema Definition和具体实现resolver functions</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Graph-js实现</span></span><br><span class="line"><span class="keyword">const</span> UserType = <span class="keyword">new</span> GraphQLObjectType(&#123;</span><br><span class="line">  name: <span class="string">'User'</span>,</span><br><span class="line">  fields: &#123;</span><br><span class="line">    id: &#123; <span class="attr">type</span>: GraphQLID &#125;,</span><br><span class="line">    name: &#123; <span class="attr">type</span>: GraphQLString &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> schema = <span class="keyword">new</span> GraphQLSchema(&#123;</span><br><span class="line">  query: <span class="keyword">new</span> GraphQLObjectType(&#123;</span><br><span class="line">    name: <span class="string">'Query'</span>,</span><br><span class="line">    fields: &#123;</span><br><span class="line">      user: &#123;</span><br><span class="line">        type: UserType,</span><br><span class="line">        args: &#123;</span><br><span class="line">          id: &#123; <span class="attr">type</span>: GraphQLID &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * root: 前一个resolver function调用的返回结果，初始值为null</span></span><br><span class="line"><span class="comment">         * args: 请求参数</span></span><br><span class="line"><span class="comment">         * context: resolver上下文</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        resolve: <span class="function">(<span class="params">root, args, context, info</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; id &#125; = args <span class="comment">// the `id` argument for this field is declared above</span></span><br><span class="line">          <span class="keyword">return</span> fetchUserById(id) <span class="comment">// hit the database</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Since a GraphQL query at its essence is just a collection of fields, all a GraphQL server actually needs to do in order to gather the requested data is invoke all the resolver functions for the fields specified in the query.<br>Schema，每个字段都有一个Resolver function，</p>
<p><code>graphql-tools</code>：the biggest benefit of using graphql-tools is its nice API for connecting your declarative schema with resolvers!</p>
<p>Resolver function方法剖析</p>
<p>GraphQL查询及返回 是怎么在网络间传输的？</p>
<p>由于Express解决了如何处理http请求，而graphql.js解决了如何查询的功能？现在就是怎么将其结合起来的问题？这时候就出现了express-graphql和apollo-server库，它们实际上都只是express的中间件。</p>
<p>express-graphql: 主要包含两部分功能<br>(1) 保证包含在POST请求体中的GraphQL query (或者mutation)，可以被GraphQL.js执行，所以,它需要解析查询并将其转发给graphql函数执行。<br>(2) 将执行的结果附加到响应对象,因此它可以返回给客户端。</p>
<p><a href="https://github.com/graphql/express-graphql/blob/master/src/index.js" target="_blank" rel="noopener">源码解读</a></p>
<p>apollo-server：其实跟express-graph类似，但是它集成了更多的框架，比如express、koa、hapi等，想要使用的话，只要安装相应的包，比如apollo-server-express.</p>
<p>GraphQL服务通过express-graphql起来之后可以使用任意的库发起携带query(variables)参数的POST请求. query实际上就是一个字符串，可以使用<a href="https://github.com/apollographql/graphql-tag" target="_blank" rel="noopener">graphql-tag</a>模板库，具备更多的功能。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">'/graphql'</span>, &#123;</span><br><span class="line">  method: <span class="string">'POST'</span>,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123;<span class="attr">query</span>: <span class="string">"&#123; hello &#125;"</span>&#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> response.json()</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'data:'</span>, data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>GraphQL是标准<br>GraphQL.js是底层实现<br>express-graphql是网关层，<br>apollo-server同样是网关层</p>
<p>现有的GraphQL服务端，基本上都是依赖于Graphql.js的，所以要学习建议从<a href="https://graphql.org/graphql-js/" target="_blank" rel="noopener">这里</a>入门</p>
<h4 id="Object-types"><a href="#Object-types" class="headerlink" title="Object types"></a>Object types</h4><p>This way of defining object types often provides advantages over a traditional REST API. Instead of doing one API request to get basic information about an object, and then multiple subsequent API requests to find out more information about that object, you can get all of that information in one API request. That saves bandwidth, makes your app run faster, and simplifies your client-side logic.</p>
<p>GraphQL 这种方式能够将原有 RESTful 风格时的多次请求聚合成一次请求，不仅能够减少多次请求带来的延迟，还能够降低服务器压力，加快前端的渲染速度。 不太理解？<br>设想一种场景：<br>查询一个文章的信息，comments需要去调另一个服务的。<br>移动端需要的数据结构类似于<br>{<br>  post(id: 3500401) {<br>    id,<br>    title,<br>    stars<br>  }<br>}</p>
<p>web端需要的数据结构类似于<br>{<br>  post(id: 3500401) {<br>    title,<br>    comments<br>  }<br>}</p>
<p>对比一下，我们发现只是少了两个字段，多了一个字段而已。如果要实现我们的目标，即复用同一个接口来支持这两种业务的话，会有以下几种做法：<br>  (1) 用同一个接口，这个接口提供了所有数据。这样做的好处是实现起来简单，但缺点是对业务做判断的逻辑会增多，而且对于业务来说，响应内容中有些数据根本用不到；<br>  (2) 使用参数来区分不同的业务方并返回相应的数据。好处仍然是实现简单，虽然不会有用不到的数据返回，但是仍然需要增加业务逻辑判断，会造成以后维护的困难。<br>  (3) 以牺牲web端逻辑复杂度为代价，为web端再单独提供一个根据post查询comments的接口。</p>
<p>全部返回，服务器都需要去查询comments服务，即使移动端是不需要这个字段的，不但增加带宽，而且也造成了服务器压力增大，<br>增加参数字段，if…else区分返回，就会造成代码耦合，后期代码维护成本增加。</p>
<p>而GraphQL解决了这个问题，提供所有字段的resolve function，只要移动端的查询字段中不包含comments字段，则comment resolve function不会调用，所以也需要调用comment服务，自然也不会存在额外的服务器压力。</p>

      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>您的赞赏，将是我不断前进的动力!</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/common/wechatpay.jpg" alt="苏三 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/common/alipay.jpg" alt="苏三 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/webpack/" rel="next" title="webpack扫盲">
                <i class="fa fa-chevron-left"></i> webpack扫盲
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/graphql-client/" rel="prev" title="GraphQL-API查询篇">
                GraphQL-API查询篇 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div id="gitalk-container">
    </div>
    
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/common/avatar.jpg" alt="苏三">
            
              <p class="site-author-name" itemprop="name">苏三</p>
              <p class="site-description motion-element" itemprop="description">一枚文科毕业，工作5+年的程序媛👨‍💻。</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/susan-github" title="GitHub &rarr; https://github.com/susan-github" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.jianshu.com/u/e6981e9cdded" title="简书 &rarr; https://www.jianshu.com/u/e6981e9cdded" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>简书</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Query"><span class="nav-number">1.</span> <span class="nav-text">Query</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#字段"><span class="nav-number">1.1.</span> <span class="nav-text">字段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#参数"><span class="nav-number">1.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#别名"><span class="nav-number">1.3.</span> <span class="nav-text">别名</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#片段"><span class="nav-number">1.4.</span> <span class="nav-text">片段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#操作名称"><span class="nav-number">1.5.</span> <span class="nav-text">操作名称</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#变量"><span class="nav-number">1.6.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#指令"><span class="nav-number">1.7.</span> <span class="nav-text">指令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mutation"><span class="nav-number">2.</span> <span class="nav-text">Mutation</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#InputType"><span class="nav-number">2.1.</span> <span class="nav-text">InputType</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#内联片段-定义接口interface和联合类型String-Number"><span class="nav-number">2.2.</span> <span class="nav-text">内联片段(定义接口interface和联合类型String | Number)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#typename"><span class="nav-number">2.3.</span> <span class="nav-text">__typename</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Schema和类型"><span class="nav-number">3.</span> <span class="nav-text">Schema和类型</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#标量类型"><span class="nav-number">3.1.</span> <span class="nav-text">标量类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#其他"><span class="nav-number">3.2.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#列表和非空"><span class="nav-number">3.2.1.</span> <span class="nav-text">列表和非空</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#接口"><span class="nav-number">3.2.2.</span> <span class="nav-text">接口</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#联合类型"><span class="nav-number">3.2.3.</span> <span class="nav-text">联合类型</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#输入类型-InputTypes"><span class="nav-number">3.2.4.</span> <span class="nav-text">输入类型(InputTypes)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GraphQL执行过程"><span class="nav-number">4.</span> <span class="nav-text">GraphQL执行过程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Resolver"><span class="nav-number">4.1.</span> <span class="nav-text">Resolver</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#deprecated有待研究"><span class="nav-number">5.</span> <span class="nav-text">@deprecated有待研究</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Object-types"><span class="nav-number">6.</span> <span class="nav-text">Object types</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苏三</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v6.6.0</div>





    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div>
      <span id="busuanzi_container_site_pv">本站总访问量:<span id="busuanzi_value_site_pv"></span>次</span>
      <span class="post-meta-divider">|</span>
      <span id="busuanzi_container_site_uv">本站访客数:<span id="busuanzi_value_site_uv"></span>人</span>
      <span class="post-meta-divider">|</span>
      <span id="busuanzi_container_page_pv">本文总阅读量:<span id="busuanzi_value_page_pv"></span>次</span>
    </div>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.6.0"></script>
<script src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  











  
  
  <script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>

  
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.css">

  
  
  <script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

   <script>
        var gitalk = new Gitalk({
          clientID: 'c50df27053281fcfc60c',
          clientSecret: '9abdd806e5d89917e67dd782c7c85efd8fe51ef0',
          repo: 'susan-github.github.io',
          owner: 'susan-github',
          admin: ['susan-github'],
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')
       </script>


  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

  <!-- 代码块复制功能 -->
  <script type="text/javascript" src="/js/src/clipboard/clipboard.min.js"></script>  
  <script type="text/javascript" src="/js/src/clipboard/clipboard-use.js"></script>
</body>
</html>
